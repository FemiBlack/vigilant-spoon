
  name: Deploy to GCE
  
  on:
    push:
      branches:
        - main
  
  jobs:
    deploy:
      runs-on: ubuntu-latest
  
      steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
  
      - name: Configure Docker to use gcloud as a credential helper
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 363.0.0'

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCE_SSH_PRIVATE_KEY }}" > ~/.ssh/google_compute_engine
          chmod 600 ~/.ssh/google_compute_engine
          ssh-keyscan "${{ secrets.GCE_INSTANCE_IP }}" >> ~/.ssh/known_hosts
  
      - name: Build Docker images
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SHORT_SHA: ${{ github.sha }}
        run: |
          docker-compose -f docker-compose.yml build

      - name: List Docker images
        run: |
          docker-compose -f docker-compose.yml config --images > image_names.txt

      - name: Tag and push Docker images
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SHORT_SHA: ${{ github.sha }}
        run: |
          while IFS= read -r image; do
            docker tag $image us-central1-docker.pkg.dev/${PROJECT_ID}/test2-repo/$image:${SHORT_SHA}
            docker push us-central1-docker.pkg.dev/${PROJECT_ID}/test2-repo/$image:${SHORT_SHA}
          done < image_names.txt
        
      - name: Copy Docker Compose file to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.GCE_INSTANCE_IP }}
          username: GFC
          key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
          source: docker-compose.yml
          target: /home/GFC
  
      # - name: Deploy to GCE 
      #   id: compute-ssh
      #   uses: google-github-actions/ssh-compute@v1
      #   with:
      #     instance_name: 'test2'
      #     zone: 'us-central1-a'
      #     ssh_private_key: ${{ secrets.GCE_SSH_PRIVATE_KEY }}
      #     command: '"echo test123"'
      - name: Setup Docker Compose
        run: ssh -i ~/.ssh/google_compute_engine GFC@${{ secrets.GCE_INSTANCE_IP }} 'bash -ic "curl https://gist.githubusercontent.com/FemiBlack/e2df4fab82ba697fe33c24133533095e/raw/dee55d11b4104c55d2dc09c2d9ee82b7e0380fa3/installer.sh | bash && source /home/GFC/.bashrc && docker-compose pull && docker-compose up"'
        
      # - name: BashRC
      #   run: ssh -i ~/.ssh/google_compute_engine GFC@${{ secrets.GCE_INSTANCE_IP }} 'bash -c "source /home/GFC/.bashrc"'
        
      # - name: Deploy to VM
      #   run: ssh -i ~/.ssh/google_compute_engine GFC@${{ secrets.GCE_INSTANCE_IP }} 'docker-compose pull && docker-compose up'
        # run: |
          # gcloud compute ssh test2 --quiet --tunnel-through-iap --zone us-central1-a --ssh-key-file ~/.ssh/google_compute_engine --command "echo test > /home/GFC/teste.txt"
      
      - name: Output SSH command results
        run: |
          echo '${{ steps.compute-ssh.outputs.stdout }}'
          echo '${{ steps.compute-ssh.outputs.stderr }}'
    
